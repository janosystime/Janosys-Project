<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Relatório Demográfico - PMSJC</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/swiper@9/swiper-bundle.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css"
    />
  </head>
  <body id="topo">
    <div class="page-wrapper">
      <!-- HEADER -->
      <header class="header-pmsjc">
        <img
          src="{{ url_for('static', filename='images/brasao.png') }}"
          alt="Brasão de São José dos Campos"
          width="80"
        />
        <div class="header-text text-center">
          <h1>
            <i class="fas fa-city icon-animated pulse"></i> Prefeitura de São
            José dos Campos
          </h1>
          <p style="text-align: center">
            <i class="fas fa-handshake icon-animated float"></i> Compromisso com
            a cidade e seus cidadãos
          </p>
        </div>
        <img
          src="{{ url_for('static', filename='images/bandeira.jpg') }}"
          alt="Bandeira de São José dos Campos"
          width="80"
          id="bandeira"
        />
      </header>

      <!-- MAIN -->
      <main class="container my-4 flex-grow-1">
        <div class="graphic-container mb-4" id="graphic-container">
          <div class="dropdown">
            <button><i class="fas fa-chart-pie"></i> Gráficos</button>
            <div class="content">
              <a onclick="chamaGraphDensPop()">
                <i class="fas fa-users"></i> Densidade Populacional
              </a>
              <a onclick="chamaGraphEtariaRegiao()">
                <i class="fas fa-chart-line"></i> Faixa Etária e Região
              </a>
              <a onclick="chamaGraphCreche()">
                <i class="fas fa-child"></i> Crianças e Creches
              </a>
            </div>
          </div>

          <div class="container-div-helper-img">
            <img
              src="{{ url_for('static', filename='images/help.png') }}"
              alt="Ajuda"
              class="help-img"
              id="help-btn"
              style="cursor: pointer"
              title="Ajuda"
            />
          </div>

          <iframe
            src="{{ url_for('static', filename='iframes/grafico_regioes.html') }}"
            frameborder="0"
            width="100%"
            height="682"
            title="Gráfico de Regiões"
            id="grafico-iframe"
            class="d-block mx-auto"
          ></iframe>
        </div>

        <!-- CARDS -->
        <div class="stats-cards mb-4">
          <div class="card-stat text-center icon-animated">
            <i class="fas fa-users fa-2x mb-2 pulse"></i>
            <h4 id="card-total">0</h4>
            <p id="label-card1">População Total</p>
          </div>
          <div class="card-stat text-center icon-animated">
            <i class="fas fa-chart-bar fa-2x mb-2 pulse"></i>
            <h4 id="card-criancas">0</h4>
            <p id="label-card2">Maior População</p>
          </div>
          <div class="card-stat text-center icon-animated">
            <i class="fas fa-chart-area fa-2x mb-2 pulse"></i>
            <h4 id="card-idosos">0</h4>
            <p id="label-card3">Menor População</p>
          </div>
        </div>
      </main>

      <!-- BOTÃO VOLTAR AO TOPO -->
      <button
        class="btn-voltar-topo"
        onclick="window.scrollTo({ top: 0, behavior: 'smooth' });"
        title="Voltar ao topo"
      ></button>

      <!-- FOOTER -->
      <footer class="footer-pmsjc text-center p-3">
        <i class="fas fa-landmark icon-animated float"></i>
        <span class="fw-bold"> PMSJC</span> |
        <i class="fas fa-code icon-animated pulse"></i>
        <span class="fw-bold"> JanoSys Technologies</span>
      </footer>
    </div>

    <!-- SCRIPTS -->
    <script>
      const iframe = document.getElementById("grafico-iframe");
      const card1 = document.getElementById("card-total");
      const labelCard1 = document.getElementById("label-card1");
      const card2 = document.getElementById("card-criancas");
      const labelCard2 = document.getElementById("label-card2");
      const card3 = document.getElementById("card-idosos");
      const labelCard3 = document.getElementById("label-card3");

      function chamaGraphDensPop() {
        iframe.src = "{{ url_for('static', filename='iframes/grafico_regioes.html') }}";
        labelCard1.textContent = "População Total";
        labelCard2.textContent = "Maior População";
        labelCard3.textContent = "Menor População";
        card1.textContent = "0";
        card2.textContent = "0";
        card3.textContent = "0";
      }

      function chamaGraphEtariaRegiao() {
        iframe.src = "{{ url_for('static', filename='iframes/grafico_etaria_regiao.html') }}";
        labelCard1.textContent = "Adultos (20-59)";
        labelCard2.textContent = "Região + Crianças";
        labelCard3.textContent = "Região + Idosos";
        card1.textContent = "0";
        card2.textContent = "0";
        card3.textContent = "0";
      }

      function chamaGraphCreche() {
        iframe.src = "{{ url_for('static', filename='iframes/grafico_regioes.html') }}";
        labelCard1.textContent = "Crianças em Creche";
        labelCard2.textContent = "% Cobertura Creche";
        labelCard3.textContent = "Vagas Disponíveis";
        card1.textContent = "0";
        card2.textContent = "0";
        card3.textContent = "0";
      }

      function atualizarCards(data) {
        const label1 = labelCard1.textContent;

        if (label1 === "Adultos (20-59)") {
          card1.textContent =
            data.faixasEtarias && data.faixasEtarias.adultos !== undefined
              ? data.faixasEtarias.adultos.toLocaleString("pt-BR")
              : "0";
          card2.textContent =
            data.faixasEtarias && data.faixasEtarias.regiaoMaisCriancas
              ? data.faixasEtarias.regiaoMaisCriancas
              : "N/A";
          card3.textContent =
            data.faixasEtarias && data.faixasEtarias.regiaoMaisIdosos
              ? data.faixasEtarias.regiaoMaisIdosos
              : "N/A";
        } else if (label1 === "Crianças em Creche") {
          card1.textContent =
            data.creche && data.creche.total !== undefined
              ? data.creche.total.toLocaleString("pt-BR")
              : "0";
          card2.textContent =
            data.creche && data.creche.cobertura !== undefined
              ? `${data.creche.cobertura}%`
              : "0%";
          card3.textContent =
            data.creche && data.creche.vagas !== undefined
              ? data.creche.vagas.toLocaleString("pt-BR")
              : "0";
        } else {
          card1.textContent =
            data.total !== undefined ? data.total.toLocaleString("pt-BR") : "0";
          if (data.regioes && data.regioes.length > 0) {
            const sortedRegioes = [...data.regioes].sort(
              (a, b) => b.valor - a.valor
            );
            card2.textContent = `${
              sortedRegioes[0].nome
            }: ${sortedRegioes[0].valor.toLocaleString("pt-BR")}`;
            card3.textContent = `${
              sortedRegioes[sortedRegioes.length - 1].nome
            }: ${sortedRegioes[sortedRegioes.length - 1].valor.toLocaleString(
              "pt-BR"
            )}`;
          } else {
            card2.textContent = "N/A";
            card3.textContent = "N/A";
          }
        }
      }

      window.addEventListener("message", (event) => {
        const data = event.data;
        if (!data || data.type !== "updateDemographics") return;
        atualizarCards(data);
      });
    </script>

    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
  </body>
</html>
