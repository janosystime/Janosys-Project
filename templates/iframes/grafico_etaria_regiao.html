<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
    <title>Gráfico — Faixa Etária por Região / Censo 2022</title>

    <style>
      html,
      body {
        margin: 0;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        color: #222;
      }
      .wrap {
        display: flex;
        flex-direction: column;
        gap: 14px;
        padding: 20px;
      }
      .wrap h2 {
        font-size: 1.3rem;
        font-weight: 800;
        color: #333;
        margin: 0 0 8px 0;
        text-transform: uppercase;
        letter-spacing: 1px;
      }
      .wrap p.source {
        font-size: 0.85rem;
        color: #666;
        margin: 0;
      }
      #plot {
        width: 100%;
        height: 70vh;
      }
      .age-scroll-container {
        position: relative;
        display: flex;
        align-items: center;
        width: 100%;
      }
      .age-filters {
        display: flex;
        flex-wrap: nowrap;
        gap: 8px;
        margin-top: 10px;
        overflow-x: auto;
        padding-bottom: 5px;
        position: relative;
      }
      .age-filters::-webkit-scrollbar {
        display: none;
      }
      .arrow-btn {
        display: none;
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background: linear-gradient(90deg, #004d9d, #0066cc);
        color: #fff;
        border: none;
        border-radius: 50%;
        width: 25px;
        height: 25px;
        cursor: pointer;
        z-index: 5;
        font-size: 0.8rem;
        text-align: center;
        padding-bottom: 0.5em;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
      }
      .arrow-btn:hover {
        transform: translateY(-50%) scale(1.1);
        filter: brightness(1.15);
      }
      .arrow-btn.left {
        left: 4px;
      }
      .arrow-btn.right {
        right: 4px;
      }
      button {
        border: 0 !important;
        padding: 6px 14px !important;
        border-radius: 10px !important;
        font-weight: 700 !important;
        cursor: pointer !important;
        transition: all 0.2s ease !important;
        color: white !important;
        flex: 0 0 auto !important;
        white-space: nowrap !important;
      }
      button:hover {
        transform: translateY(-1px) !important;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
      }
      button.ativo {
        transform: scale(0.98) !important;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08) !important;
      }
      @media (max-width: 640px) {
        #plot {
          height: 50vh;
        }
        .wrap {
          padding: 10px;
        }
        .wrap h2 {
          font-size: 1.1rem;
        }
        .wrap p.source {
          font-size: 0.75rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h2>População por Faixa Etária — Censo 2022</h2>
      <p class="source">Fonte: IBGE / consolidação municipal (2022).</p>
      <div class="age-filters" id="age-filters"></div>
      <div id="plot"></div>
    </div>

    <script>
      (async function () {
        const regions = ["Centro", "Leste", "Norte", "Oeste", "Sudeste", "Sul"];
        const ageGroups = ["Criança", "Jovem", "Adulto", "Idoso"];

        const ageColors = {
          Criança: "#e74c3c",
          Jovem: "#3498db",
          Adulto: "#2ecc71",
          Idoso: "#f39c12",
        };

        function setButtonColor(btn, group, isActive) {
          const color = ageColors[group];
          btn.style.backgroundColor = isActive ? color : color + "66";
          btn.style.transform = isActive ? "scale(0.98)" : "none";
        }

        const regionMap = {
          Centro: ["03", "03A", "04", "20", "26"],
          Leste: ["05", "05A", "06", "06A", "07", "08", "27", "30", "31", "33"],
          Norte: ["01", "01A", "02", "02A", "25", "25A", "32"],
          Oeste: ["17", "17A", "18", "19"],
          Sudeste: ["09", "10", "29"],
          Sul: ["11", "12", "13", "14", "15", "16", "28", "21"],
        };

        async function carregarCSV(url) {
          try {
            const resp = await fetch(url);
            if (!resp.ok) throw new Error("CSV não encontrado");
            const text = await resp.text();
            const lines = text.split("\n").filter((l) => l.trim() !== "");

            const data = {};
            regions.forEach(
              (r) => (data[r] = { Criança: 0, Jovem: 0, Adulto: 0, Idoso: 0 })
            );

            lines.slice(1).forEach((line) => {
              const cols = line.split(";");
              const setor = cols[4].match(/\d+/)?.[0] ?? "";
              const idade = {
                "0 a 4": Number(cols[7]?.replace(/\./g, "")) || 0,
                "5 a 9": Number(cols[10]?.replace(/\./g, "")) || 0,
                "10 a 14": Number(cols[11]?.replace(/\./g, "")) || 0,
                "15 a 19": Number(cols[12]?.replace(/\./g, "")) || 0,
                "20 a 24": Number(cols[15]?.replace(/\./g, "")) || 0,
                "25 a 29": Number(cols[16]?.replace(/\./g, "")) || 0,
                "30 a 39": Number(cols[17]?.replace(/\./g, "")) || 0,
                "40 a 49": Number(cols[18]?.replace(/\./g, "")) || 0,
                "50 a 59": Number(cols[19]?.replace(/\./g, "")) || 0,
                "60 a 64": Number(cols[20]?.replace(/\./g, "")) || 0,
                "65 a 69": Number(cols[21]?.replace(/\./g, "")) || 0,
                "70+": Number(cols[22]?.replace(/\./g, "")) || 0,
              };

              for (const r of regions) {
                if (regionMap[r].includes(setor)) {
                  data[r]["Criança"] += idade["0 a 4"];
                  data[r]["Jovem"] +=
                    idade["5 a 9"] + idade["10 a 14"] + idade["15 a 19"];
                  data[r]["Adulto"] +=
                    idade["20 a 24"] +
                    idade["25 a 29"] +
                    idade["30 a 39"] +
                    idade["40 a 49"] +
                    idade["50 a 59"] +
                    idade["60 a 64"];
                  data[r]["Idoso"] += idade["65 a 69"] + idade["70+"];
                }
              }
            });
            return data;
          } catch (e) {
            console.warn("Falha ao carregar CSV, usando mock");
            const mock = {};
            regions.forEach(
              (r) =>
                (mock[r] = {
                  Criança: 5000,
                  Jovem: 12000,
                  Adulto: 30000,
                  Idoso: 8000,
                })
            );
            return mock;
          }
        }

        const regionData = await carregarCSV("dados_sjc.csv");

        const regionDataTotal = {
          Criança: regions.reduce(
            (sum, r) => sum + regionData[r]["Criança"],
            0
          ),
          Jovem: regions.reduce((sum, r) => sum + regionData[r]["Jovem"], 0),
          Adulto: regions.reduce((sum, r) => sum + regionData[r]["Adulto"], 0),
          Idoso: regions.reduce((sum, r) => sum + regionData[r]["Idoso"], 0),
        };

        let selectedAges = [...ageGroups];

        function makeTraces(filteredAges) {
          const isMobile = window.innerWidth <= 640;
          return filteredAges.map((age) => ({
            x: regions,
            y: regions.map((r) => regionData[r][age]),
            type: "bar",
            name: age,
            marker: {
              color: ageColors[age],
              line: { width: 1, color: ageColors[age] },
            },
            text: regions.map((r) => regionData[r][age].toLocaleString()),
            textposition: isMobile ? "inside" : "outside",
            textfont: {
              size: isMobile ? 12 : 14,
              color: isMobile ? "#fff" : "#333",
              family: "Segoe UI, sans-serif",
            },
            insidetextanchor: "middle",
            outsidetextfont: {
              size: isMobile ? 12 : 14,
              color: "#333",
            },
            hovertemplate: "%{x} - " + age + ": %{text}<extra></extra>",
            showlegend: false,
          }));
        }

        const layout = {
          barmode: window.innerWidth <= 640 ? "stack" : "group",
          margin: { t: window.innerWidth <= 640 ? 40 : 60, r: 16, l: 50, b: 40 },
          xaxis: {
            tickangle: 0,
            automargin: true,
            showgrid: false,
            zeroline: false,
            showline: false,
          },
          yaxis: {
            tickformat: ",d",
            showgrid: false,
            zeroline: false,
            showline: false,
          },
          hovermode: "closest",
          font: {
            family: "Segoe UI, Tahoma, Geneva, Verdana, sans-serif",
            color: "#222",
          },
          paper_bgcolor: "rgba(0,0,0,0)",
          plot_bgcolor: "rgba(0,0,0,0)",
          transition: { duration: 600, easing: "cubic-in-out" },
          showlegend: false,
        };

        const config = {
          responsive: true,
          displayModeBar: false,
          displaylogo: false,
        };

        function sendDemographicsData() {
          let regiaoMaisCriancas = "",
            regiaoMaisIdosos = "";
          let maxCriancas = 0,
            maxIdosos = 0;

          regions.forEach((regiao) => {
            if (selectedAges.includes("Criança") && regionData[regiao]["Criança"] > maxCriancas) {
              maxCriancas = regionData[regiao]["Criança"];
              regiaoMaisCriancas = `${regiao}: ${maxCriancas.toLocaleString("pt-BR")}`;
            }
            if (selectedAges.includes("Idoso") && regionData[regiao]["Idoso"] > maxIdosos) {
              maxIdosos = regionData[regiao]["Idoso"];
              regiaoMaisIdosos = `${regiao}: ${maxIdosos.toLocaleString("pt-BR")}`;
            }
          });

          window.parent.postMessage(
            {
              type: "updateDemographics",
              faixasEtarias: {
                adultos: selectedAges.includes("Adulto")
                  ? regionDataTotal["Adulto"]
                  : 0,
                regiaoMaisCriancas: selectedAges.includes("Criança")
                  ? regiaoMaisCriancas
                  : "N/A",
                regiaoMaisIdosos: selectedAges.includes("Idoso")
                  ? regiaoMaisIdosos
                  : "N/A",
              },
            },
            "*"
          );
        }

        function updatePlot() {
          layout.barmode = window.innerWidth <= 640 ? "stack" : "group";
          layout.margin.t = window.innerWidth <= 640 ? 40 : 60;
          Plotly.react("plot", makeTraces(selectedAges), layout, config);
          sendDemographicsData(); // Enviar dados atualizados ao mudar filtros
        }

        const filterContainer = document.getElementById("age-filters");

        ageGroups.forEach((group) => {
          const btn = document.createElement("button");
          btn.textContent = group;
          btn.classList.add("ativo");
          setButtonColor(btn, group, true);

          btn.addEventListener("click", () => {
            const index = selectedAges.indexOf(group);
            if (index > -1) {
              selectedAges.splice(index, 1);
              btn.classList.remove("ativo");
              setButtonColor(btn, group, false);
            } else {
              selectedAges.push(group);
              btn.classList.add("ativo");
              setButtonColor(btn, group, true);
            }
            updatePlot();
            Plotly.Plots.resize("plot");
          });

          filterContainer.appendChild(btn);
        });

        updatePlot();

        // Adicionar evento de redimensionamento da janela
        window.addEventListener("resize", () => {
          updatePlot(); // Atualiza barmode, margens e dados
          Plotly.Plots.resize("plot");
        });

        // Rolagem com as setas no mobile
        const scrollContainer = document.getElementById("age-filters");
        const btnLeft = document.getElementById("scroll-left");
        const btnRight = document.getElementById("scroll-right");

        btnLeft.addEventListener("click", () => {
          scrollContainer.scrollBy({ left: -100, behavior: "smooth" });
        });

        btnRight.addEventListener("click", () => {
          scrollContainer.scrollBy({ left: 100, behavior: "smooth" });
        });

        // Enviar dados iniciais
        sendDemographicsData();
      })();
    </script>
  </body>
</html>