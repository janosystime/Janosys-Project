<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Relat√≥rio Demogr√°fico - PMSJC</title>
    <link href="../static/css/style.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@9/swiper-bundle.min.css"/>
  </head>
  <body id="topo">
    <div class="page-wrapper">
      <header class="header-pmsjc">
        <img
          src="../static/images/brasao.png"
          alt="Bras√£o de S√£o Jos√© dos Campos"
          width="80"
        />
        <div class="header-text text-center">
          <h1>Prefeitura de S√£o Jos√© dos Campos</h1>
          <p>Compromisso com a cidade e seus cidad√£os</p>
        </div>
        <img
          src="../static/images/bandeira.jpg"
          alt="Bandeira de S√£o Jos√© dos Campos"
          width="80"
          id="bandeira"
        />
      </header>

      <main class="container my-4 flex-grow-1">
        <div class="graphic-container mb-4" id="graphic-container">
          <div class="dropdown">
            <button>Gr√°ficos ‚¨á</button>
            <div class="content">
              <a onclick="chamaGraphDensPop()">Densidade Populacional</a>
              <a onclick="chamaGraphEtariaRegiao()">Faixa Et√°ria e Regi√£o</a>
              <a onclick="chamaGraphCreche()">Crian√ßas e Creches</a>
            </div>
          </div>
          <div class="container-div-helper-img">
            <img
              src="../static/images/help.png"
              alt="Ajuda"
              class="help-img"
              id="help-btn"
              style="cursor: pointer"
            />
          </div>
          <iframe
            src="./iframes/grafico_regioes.html"
            frameborder="0"
            width="100%"
            height="682"
            title="Gr√°fico de Regi√µes"
            id="grafico-iframe"
            class="d-block mx-auto"
          ></iframe>
        </div>

        <!-- CARDS -->
        <div class="stats-cards mb-4">
          <div class="card-stat text-center">
            <h4 id="card-total">0</h4>
            <p id="label-card1">Popula√ß√£o Total</p>
          </div>
          <div class="card-stat text-center">
            <h4 id="card-criancas">0</h4>
            <p id="label-card2">Maior Popula√ß√£o</p>
          </div>
          <div class="card-stat text-center">
            <h4 id="card-idosos">0</h4>
            <p id="label-card3">Menor Popula√ß√£o</p>
          </div>
        </div>

    <script>
      const iframe = document.getElementById('grafico-iframe')
      const card1 = document.getElementById('card-total')
      const labelCard1 = document.getElementById('label-card1')
      const card2 = document.getElementById('card-criancas')
      const labelCard2 = document.getElementById('label-card2')
      const card3 = document.getElementById('card-idosos')
      const labelCard3 = document.getElementById('label-card3')

      function chamaGraphDensPop(){
        iframe.src = './iframes/grafico_regioes.html'
        labelCard1.textContent = 'Popula√ß√£o Total'
        labelCard2.textContent = 'Maior Popula√ß√£o'
        labelCard3.textContent = 'Menor Popula√ß√£o'
      }

      function chamaGraphEtariaRegiao(){
        iframe.src = './iframes/grafico_etaria_regiao.html'
        labelCard1.textContent = 'Adultos (20-59)'
        labelCard2.textContent = 'Regi√£o + Crian√ßas'
        labelCard3.textContent = 'Regi√£o + Idosos'
      }

      function chamaGraphCreche(){
        iframe.src = './iframes/grafico_creche.html'
        labelCard1.textContent = 'Crian√ßas em Creche'
        labelCard2.textContent = '% Cobertura Creche'
        labelCard3.textContent = 'Vagas Dispon√≠veis'
      }

      // ‚úÖ SISTEMA DE CARDS INTELIGENTE - FUNCIONA COM TODOS OS GR√ÅFICOS
      function atualizarCards(data) {
        const label1 = labelCard1.textContent
        
        if (label1 === 'Adultos (20-59)') {
          // üéØ FAIXA ET√ÅRIA POR REGI√ÉO
          card1.textContent = data.faixasEtarias.adultos.toLocaleString("pt-BR")
          card2.textContent = data.faixasEtarias.regiaoMaisCriancas
          card3.textContent = data.faixasEtarias.regiaoMaisIdosos
          
        } else if (label1 === 'Crian√ßas em Creche') {
          // üè´ CRIAN√áAS E CRECHES
          card1.textContent = data.creche.total.toLocaleString("pt-BR")
          card2.textContent = `${data.creche.cobertura}%`
          card3.textContent = data.creche.vagas.toLocaleString("pt-BR")
          
        } else {
          // üìä DENISDADE POPULACIONAL (PADR√ÉO)
          card1.textContent = data.total.toLocaleString("pt-BR")
          
          // Maior e menor popula√ß√£o
          const sortedRegioes = [...data.regioes].sort((a, b) => b.valor - a.valor)
          card2.textContent = `${sortedRegioes[0].nome}: ${sortedRegioes[0].valor.toLocaleString("pt-BR")}`
          card3.textContent = `${sortedRegioes[sortedRegioes.length-1].nome}: ${sortedRegioes[sortedRegioes.length-1].valor.toLocaleString("pt-BR")}`
        }
      }

      // ‚úÖ RECEBE DADOS DE QUALQUER GR√ÅFICO
      window.addEventListener("message", (event) => {
        const data = event.data
        if (!data || data.type !== "updateDemographics") return
        
        atualizarCards(data)
        
        // Progress bars (s√≥ para densidade)
        if (data.regioes && document.getElementById("progress-container")) {
          const container = document.getElementById("progress-container")
          container.innerHTML = ""
          
          const sorted = [...data.regioes].sort((a, b) => b.valor - a.valor)
          sorted.forEach((r) => {
            const perc = ((r.valor / data.total) * 100).toFixed(2)
            const wrapper = document.createElement("div")
            wrapper.className = "progress mb-3 progress-gradient"
            wrapper.setAttribute("data-tooltip", `${r.nome}: ${r.valor.toLocaleString("pt-BR")} hab. (${perc}%)`)
            
            const bar = document.createElement("div")
            bar.className = "progress-bar d-flex justify-content-center align-items-center"
            bar.style.width = perc + "%"
            bar.textContent = `${r.nome} - ${perc}%`
            
            wrapper.appendChild(bar)
            container.appendChild(wrapper)
          })
        }
      })

      // Tooltip custom
      document.addEventListener("mouseover", (e) => {
        const barWrapper = e.target.closest(".progress")
        if (barWrapper) {
          const tooltip = document.createElement("div")
          tooltip.className = "tooltip-custom"
          tooltip.innerText = barWrapper.getAttribute("data-tooltip")
          document.body.appendChild(tooltip)

          const rect = barWrapper.getBoundingClientRect()
          tooltip.style.left = rect.left + rect.width / 2 - tooltip.offsetWidth / 2 + "px"
          tooltip.style.top = rect.top - tooltip.offsetHeight - 8 + "px"

          tooltip.style.opacity = 0
          tooltip.style.transition = "opacity 0.2s ease, transform 0.2s ease"
          requestAnimationFrame(() => {
            tooltip.style.opacity = 1
            tooltip.style.transform = "translateY(-4px)"
          })

          barWrapper.addEventListener("mouseleave", () => {
            tooltip.style.opacity = 0
            tooltip.style.transform = "translateY(0)"
            setTimeout(() => tooltip.remove(), 200)
          }, { once: true })
        }
      })
    </script>
    <script src="../static/js/script.js"></script>
  </body>
</html>