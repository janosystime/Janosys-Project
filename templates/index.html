<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Relatório Demográfico - PMSJC</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/swiper@9/swiper-bundle.min.css"
    />
  </head>
  <body id="topo">
    <div class="page-wrapper">
      <header class="header-pmsjc">
        <img
          src="images/brasao.png"
          alt="Brasão de São José dos Campos"
          width="80"
        />
        <div class="header-text text-center">
          <h1>Prefeitura de São José dos Campos</h1>
          <p>Compromisso com a cidade e seus cidadãos</p>
        </div>
        <img
          src="images/bandeira.jpg"
          alt="Bandeira de São José dos Campos"
          width="80"
          id="bandeira"
        />
      </header>

      <main class="container my-4 flex-grow-1">
        <div class="graphic-container mb-4" id="graphic-container">
          <div class="container-div-helper-img">
            <img
              src="/templates/images/help.png"
              alt="help.png"
              class="help-img"
            />
          </div>
          <iframe
            src="./iframes/grafico_regioes.html"
            frameborder="0"
            width="100%"
            height="660"
            title="Gráfico de Regiões"
            id="grafico-iframe"
            class="d-block mx-auto"
          ></iframe>
        </div>

        <!-- CARDS -->
        <div class="stats-cards mb-4">
          <div class="card-stat text-center">
            <h4 id="card-total">0</h4>
            <p>População Total</p>
          </div>
          <div class="card-stat text-center">
            <h4 id="card-criancas">0%</h4>
            <p>Crianças (0-5)</p>
          </div>
          <div class="card-stat text-center">
            <h4 id="card-idosos">0%</h4>
            <p>Idosos (60+)</p>
          </div>
        </div>

        <!-- PROGRESS -->
        <section class="col-md-12 mx-auto border-start ps-4">
          <h3 class="text-center text-pmsjc mb-4">
            Dados Demográficos de População (Região × Faixa Etária)
          </h3>
          <div id="progress-container"></div>
        </section>
      </main>

      <button
        class="btn-voltar-topo"
        onclick="window.scrollTo({ top: 0, behavior: 'smooth' });"
      ></button>

      <footer class="footer-pmsjc text-center p-3">
        <span class="fw-bold">PMSJC</span> |
        <span class="fw-bold">JanoSys Technologies</span>
      </footer>
    </div>

    <script>
      // Atualiza os cards diretamente sem animação de contagem
      function atualizarCards(total, criancas, idosos) {
        document.getElementById("card-total").textContent =
          total.toLocaleString("pt-BR");
        document.getElementById(
          "card-criancas"
        ).textContent = `${criancas.toLocaleString("pt-BR")} (${(
          (criancas / total) *
          100
        ).toFixed(2)}%)`;
        document.getElementById(
          "card-idosos"
        ).textContent = `${idosos.toLocaleString("pt-BR")} (${(
          (idosos / total) *
          100
        ).toFixed(2)}%)`;
      }

      // Validação de dados recebidos
      window.addEventListener("message", (event) => {
        const data = event.data;
        if (!data || data.type !== "updateDemographics") return;
        if (!data.regioes || !Array.isArray(data.regioes)) return;

        const { regioes, total, criancas, idosos } = data;
        atualizarCards(total, criancas, idosos);

        const sorted = [...regioes].sort((a, b) => b.valor - a.valor); // DEFINIR sorted
        const container = document.getElementById("progress-container");
        container.innerHTML = ""; // Limpa antes de adicionar

        sorted.forEach((r) => {
          const perc = ((r.valor / total) * 100).toFixed(2);
          const wrapper = document.createElement("div");
          wrapper.className = "progress mb-3 progress-gradient";
          wrapper.setAttribute(
            "data-tooltip",
            `${r.nome}: ${r.valor.toLocaleString("pt-BR")} hab. (${perc}%)`
          );

          const bar = document.createElement("div");
          bar.className =
            "progress-bar d-flex justify-content-center align-items-center";
          bar.style.width = perc + "%";
          bar.textContent = `${r.nome} - ${perc}%`;

          wrapper.appendChild(bar);
          container.appendChild(wrapper);

          // Clique para destacar
          wrapper.addEventListener("mouseover", () => {
            document
              .querySelectorAll(".progress")
              .forEach((p) => p.classList.remove("highlight"));
            wrapper.classList.add("highlight");
          });
        });
      });

      // Tooltip custom
      document.addEventListener("mouseover", (e) => {
        const barWrapper = e.target.closest(".progress");
        if (barWrapper) {
          const tooltip = document.createElement("div");
          tooltip.className = "tooltip-custom";
          tooltip.innerText = barWrapper.getAttribute("data-tooltip");
          document.body.appendChild(tooltip);

          const rect = barWrapper.getBoundingClientRect();
          tooltip.style.left =
            rect.left + rect.width / 2 - tooltip.offsetWidth / 2 + "px";
          tooltip.style.top = rect.top - tooltip.offsetHeight - 8 + "px";

          // Animação de entrada
          tooltip.style.opacity = 0;
          tooltip.style.transition = "opacity 0.2s ease, transform 0.2s ease";
          requestAnimationFrame(() => {
            tooltip.style.opacity = 1;
            tooltip.style.transform = "translateY(-4px)";
          });

          barWrapper.addEventListener(
            "mouseleave",
            () => {
              tooltip.style.opacity = 0;
              tooltip.style.transform = "translateY(0)";
              setTimeout(() => tooltip.remove(), 200);
            },
            { once: true }
          );
        }
      });
    </script>
  </body>
</html>
